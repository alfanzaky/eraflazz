# Panduan Role Guard pada Handler

## Overview

Dokumen ini menjelaskan implementasi Role Guard pada Handler untuk pembatasan akses granular berdasarkan role pengguna (reseller vs admin vs H2H client).

## Komponen Role Guard

### 1. RoleGuard Helper
File: `internal/handler/api/role_guard.go`

#### Fungsi Utama:
- `GetCurrentUser(c)` - Mengekstrak user info dari context (user_id, role, user_level)
- `RequireRole(role)` - Middleware untuk memeriksa role spesifik
- `RequireMinimumLevel(level)` - Middleware untuk memeriksa minimum level
- `CanAccessOwnData(c, resourceUserID)` - Cek akses data sendiri vs admin
- `IsH2HClient(c)` - Cek apakah request dari H2H client
- `LogAccess(c, action, resource)` - Logging akses dengan user info

#### Role Constants:
```go
const (
    RoleReseller = "RESELLER"  // Level 1
    RoleAgent    = "AGENT"     // Level 2  
    RoleMaster   = "MASTER"    // Level 3
    RoleAdmin    = "ADMIN"     // Level 4
    RoleH2H      = "H2H"       // Special role for API clients
)
```

### 2. Integrasi pada Handler

#### TransactionHandler
- Support untuk user authentication dan H2H client authentication
- Logging akses menggunakan `roleGuard.LogAccess()`
- Contoh implementasi di `CreateTransaction()`:

```go
// Check if user or H2H client is authenticated
userID, role, userLevel, exists := h.roleGuard.GetCurrentUser(c)
if !exists {
    // Check if it's an H2H client
    if clientID, isH2H := GetClientIDFromContext(c); isH2H {
        userID = clientID
        role = domain.RoleH2H
        userLevel = domain.LevelReseller
    } else {
        xresponse.Unauthorized(c, "Authentication required")
        return
    }
}

// Log the access attempt
h.roleGuard.LogAccess(c, "create_transaction", req.ProductCode)
```

#### ProductHandler  
- Role-based access control untuk admin operations
- Contoh implementasi di `CreateProduct()`:

```go
// Check if user has admin privileges
userID, role, _, exists := h.roleGuard.GetCurrentUser(c)
if !exists || role != domain.RoleAdmin {
    logger.Warn("Access denied - insufficient privileges for create product",
        logger.String("user_id", userID),
        logger.String("role", role),
        logger.String("ip", c.ClientIP()),
    )
    xresponse.Forbidden(c, "Admin access required to create products")
    return
}

h.roleGuard.LogAccess(c, "create_product", "admin")
```

## 3. Pattern Penggunaan

### Basic Role Checking
```go
// Admin only
userID, role, _, exists := h.roleGuard.GetCurrentUser(c)
if !exists || role != domain.RoleAdmin {
    xresponse.Forbidden(c, "Admin access required")
    return
}
```

### Level-based Access
```go
// Master and above
userID, _, userLevel, exists := h.roleGuard.GetCurrentUser(c)
if !exists || userLevel < domain.LevelMaster {
    xresponse.Forbidden(c, "Master access required")
    return
}
```

### Data Ownership Check
```go
// Can only access own data (except admin)
if !h.roleGuard.CanAccessOwnData(c, resource.UserID) {
    xresponse.Forbidden(c, "Access denied to this resource")
    return
}
```

### H2H vs User Access
```go
// Support both authenticated users and H2H clients
if h.roleGuard.IsH2HClient(c) {
    // Handle H2H client logic
    clientID, _ := GetClientIDFromContext(c)
    // ... H2H specific processing
} else {
    // Handle authenticated user logic
    userID, role, _, exists := h.roleGuard.GetCurrentUser(c)
    // ... user specific processing
}
```

## 4. Security Features

### Access Logging
Setiap akses di-log dengan informasi:
- User ID atau Client ID
- Role yang digunakan
- Action yang dilakukan
- Resource yang diakses
- IP address
- Timestamp

### Permission Matrix

| Role | Create Transaction | View Own Transaction | View All Transactions | Create Product | Update Product |
|------|-------------------|---------------------|----------------------|----------------|---------------|
| Reseller | ✅ | ✅ | ❌ | ❌ | ❌ |
| Agent | ✅ | ✅ | ✅ (downline) | ❌ | ❌ |
| Master | ✅ | ✅ | ✅ (downline) | ❌ | ❌ |
| Admin | ✅ | ✅ | ✅ (all) | ✅ | ✅ |
| H2H | ✅ | ✅ (own) | ❌ | ❌ | ❌ |

### Error Handling
- **401 Unauthorized** - User tidak authenticated
- **403 Forbidden** - User tidak memiliki permission
- **500 Internal Server Error** - Error saat validasi role

## 5. Best Practices

### 1. Early Validation
Lakukan role checking di awal method sebelum processing logic.

### 2. Consistent Logging
Gunakan `roleGuard.LogAccess()` untuk konsistensi logging format.

### 3. Graceful H2H Support
Pastikan method mendukung both user authentication dan H2H client authentication.

### 4. Minimal Data Exposure
Hanya return data yang sesuai dengan role user.

### 5. Error Message Consistency
Gunakan error message yang konsisten dan tidak bocorkan informasi sensitif.

## 6. Testing

### Unit Test Pattern
```go
func TestCreateTransactionRoleAccess(t *testing.T) {
    // Test admin access
    // Test reseller access  
    // Test H2H client access
    // Test unauthorized access
}
```

### Integration Test
```bash
# Test with JWT token
curl -H "Authorization: Bearer JWT_TOKEN" /api/v1/transactions

# Test with H2H headers
curl -H "X-Client-ID: CLIENT_ID" \
     -H "X-API-Key: API_KEY" \
     -H "X-Timestamp: TIMESTAMP" \
     -H "X-Signature: SIGNATURE" \
     /api/v1/h2h/callback
```

## 7. Troubleshooting

### Common Issues
1. **Role not found in context** - Pastikan auth middleware berjalan sebelum role guard
2. **H2H client not detected** - Check H2H middleware registration
3. **Permission denied for valid user** - Verify role constants dan level mapping

### Debug Logging
Enable debug logging untuk melihat role extraction:
```go
logger.Debug("Role guard check",
    logger.String("user_id", userID),
    logger.String("role", role),
    logger.String("action", action),
)
```

## 8. Future Enhancements

### 1. Fine-grained Permissions
- Resource-based permissions
- Action-based permissions
- Time-based access control

### 2. Dynamic Role Assignment
- Runtime role changes
- Temporary role elevation
- Delegated permissions

### 3. Audit Trail
- Complete access history
- Permission change tracking
- Automated compliance reporting
