# Panduan Observability & CI Dasar

## Overview

Dokumen ini menjelaskan implementasi observability dan CI/CD pipeline untuk monitoring aplikasi Eraflazz dengan Prometheus metrics, trace ID, dan GitHub Actions.

## Komponen Observability

### 1. Prometheus Metrics

#### File: `pkg/metrics/prometheus.go`

#### Metrics yang Tersedia:

**HTTP Request Metrics:**
- `http_requests_total` - Total number of HTTP requests
- `http_request_duration_seconds` - HTTP request duration

**Business Metrics:**
- `transactions_total` - Total number of transactions
- `transaction_amount_rupiah` - Transaction amount in Rupiah

**Database Metrics:**
- `db_connections_active` - Number of active database connections
- `db_query_duration_seconds` - Database query duration

**Redis Metrics:**
- `redis_connections_active` - Number of active Redis connections
- `redis_operations_total` - Total number of Redis operations

**Queue Metrics:**
- `queue_size` - Current queue size
- `queue_processing_duration_seconds` - Queue processing duration

**Supplier Metrics:**
- `supplier_requests_total` - Total number of supplier requests
- `supplier_request_duration_seconds` - Supplier request duration

**Authentication Metrics:**
- `auth_attempts_total` - Total number of authentication attempts

**System Metrics:**
- `active_users_total` - Number of active users
- `system_errors_total` - Total number of system errors

#### Cara Penggunaan:

```go
// Record HTTP request
metrics.RecordHTTPRequest("POST", "/api/v1/transactions", "201", "reseller", 0.245)

// Record transaction
metrics.RecordTransaction("SUCCESS", "pulsa", "reseller", 10000.0)

// Record database query
metrics.RecordDBQuery("SELECT", "transactions", 0.025)

// Record system error
metrics.RecordSystemError("database_timeout", "transaction_service", err)
```

### 2. Trace ID Propagation

#### File: `pkg/observability/middleware.go`

#### Fitur:

**Trace ID Generation:**
- Otomatis generate UUID untuk setiap request
- Support trace ID dari external system via header `X-Trace-ID`

**Middleware Integration:**
- Automatic trace ID injection ke response header
- Context propagation untuk downstream services
- Request logging dengan trace ID

#### Cara Penggunaan:

```go
// Middleware registration
router.Use(observability.ObservabilityMiddleware())

// Get trace ID in handler
traceID := observability.GetTraceID(c)

// Logging with trace ID
observability.LogWithFields(c, "Transaction created",
    logger.String("trx_id", transaction.ID),
    logger.String("product_code", req.ProductCode),
)

// Error logging with trace ID
observability.LogWithError(c, err, "Failed to create transaction")

// System error recording
observability.RecordSystemError(c, "validation_error", "transaction_handler", err)
```

#### Trace ID Flow:

```
Client Request
    ↓
[Middleware] Generate/Extract Trace ID
    ↓
Set X-Trace-ID Header
    ↓
Add to Context
    ↓
Process Request
    ↓
Log with Trace ID
    ↓
Response with X-Trace-ID Header
```

### 3. Metrics Endpoints

#### File: `pkg/observability/metrics_handler.go`

#### Endpoints yang Tersedia:

**`GET /metrics`**
- Prometheus metrics endpoint
- OpenMetrics format support
- Auto-registered Go metrics

**`GET /health`**
- Basic health check
- Service status information

**`GET /ready`**
- Readiness probe
- Dependency checks

**`GET /live`**
- Liveness probe
- Basic service health

#### Integration di main.go:

```go
// Initialize metrics handler
metricsHandler := observability.NewMetricsHandler()
metricsHandler.RegisterMetrics()

// Setup endpoints
router.GET("/metrics", metricsHandler.MetricsEndpoint())
router.GET("/health", metricsHandler.HealthEndpoint())
router.GET("/ready", metricsHandler.ReadinessEndpoint())
router.GET("/live", metricsHandler.LivenessEndpoint())
```

## CI/CD Pipeline

### GitHub Actions Workflow

#### File: `.github/workflows/ci.yml`

#### Jobs yang Tersedia:

**1. Lint Job**
- golangci-lint dengan konfigurasi custom
- go fmt checking
- go vet analysis
- Code quality enforcement

**2. Test Job**
- Unit tests dengan race detection
- Coverage reporting ke Codecov
- Test result artifacts

**3. Build Job**
- Multi-platform builds (Linux, Windows, macOS)
- Multi-architecture builds (amd64, arm64)
- Build artifacts storage

**4. Security Scan Job**
- Gosec security scanner
- SARIF report upload
- govulncheck vulnerability scanning

**5. Docker Build Job**
- Multi-platform Docker builds
- Registry push ke Docker Hub
- Layer caching optimization

**6. Integration Test Job**
- Database integration tests
- Redis integration tests
- End-to-end API testing

#### Pipeline Triggers:

```yaml
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
```

#### Environment Variables:

```yaml
env:
  GO_VERSION: '1.23'
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
```

### Golangci-lint Configuration

#### File: `.golangci.yml`

#### Konfigurasi Utama:

**Performance & Complexity:**
- Max function length: 100 lines
- Max statements: 50
- Cyclomatic complexity: 15
- Cognitive complexity: 20

**Code Style:**
- Line length: 120 characters
- Import organization
- Unused variable detection
- Shadow variable checking

**Security:**
- Security vulnerability scanning
- Weak cryptography detection
- SQL injection prevention

**Testing:**
- Test coverage requirements
- Test naming conventions
- Race condition detection

## Monitoring Setup

### Prometheus Configuration

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'eraflazz-api'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s
```

### Grafana Dashboard

**Recommended Panels:**

1. **Request Rate**
   - HTTP requests per second
   - Grouped by endpoint and status

2. **Response Time**
   - Request duration percentiles
   - Slow endpoint identification

3. **Transaction Metrics**
   - Transaction success rate
   - Transaction volume trends
   - Average transaction amount

4. **System Health**
   - Database connection pool
   - Redis connection status
   - Queue depth monitoring

5. **Error Tracking**
   - System error rate
   - Error breakdown by component
   - Authentication failures

### Alerting Rules

```yaml
# alerts.yml
groups:
  - name: eraflazz-alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"

      - alert: SlowResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "95th percentile response time is high"

      - alert: DatabaseConnectionPoolExhausted
        expr: db_connections_active > 80
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool nearly exhausted"
```

## Best Practices

### 1. Trace ID Usage

**DO:**
```go
// Always include trace ID in logs
observability.LogWithFields(c, "Operation completed", 
    logger.String("operation", "create_transaction"),
    logger.String("result", "success"),
)

// Use trace ID for error correlation
observability.LogWithError(c, err, "Business logic error")
```

**DON'T:**
```go
// Don't log without trace ID
logger.Info("Operation completed") // Missing trace context
```

### 2. Metrics Recording

**DO:**
```go
// Record business metrics with proper labels
metrics.RecordTransaction("SUCCESS", "pulsa", "reseller", 10000.0)

// Use appropriate bucket sizes for histograms
metrics.RecordHTTPRequest("POST", "/api/v1/transactions", "201", "reseller", 0.245)
```

**DON'T:**
```go
// Don't record high cardinality labels
metrics.RecordTransaction(transactionID, "pulsa", "reseller", 10000.0) // Bad!
```

### 3. Error Handling

**DO:**
```go
// Use structured error logging
observability.RecordSystemError(c, "validation_error", "transaction_handler", err)

// Include context in error logs
observability.LogWithError(c, err, "Failed to process transaction",
    logger.String("user_id", userID),
    logger.String("product_code", productCode),
)
```

### 4. Performance Monitoring

**DO:**
```go
// Record database query performance
start := time.Now()
result, err := db.Query(query, args...)
metrics.RecordDBQuery("SELECT", "transactions", time.Since(start).Seconds())
```

## Troubleshooting

### Common Issues

1. **Missing Trace ID**
   - Check middleware registration order
   - Verify `X-Trace-ID` header propagation

2. **Metrics Not Available**
   - Verify Prometheus endpoint accessibility
   - Check metrics registration in main.go

3. **CI Pipeline Failures**
   - Check Go version compatibility
   - Verify secret configuration in GitHub

4. **High Memory Usage**
   - Monitor metrics cardinality
   - Check for label explosions

### Debug Commands

```bash
# Check metrics endpoint
curl http://localhost:8080/metrics

# Test trace ID propagation
curl -H "X-Trace-ID: test-trace-123" http://localhost:8080/api/v1/health

# Run linting locally
golangci-lint run

# Run tests with coverage
go test -v -race -coverprofile=coverage.out ./...

# Build multi-platform
GOOS=linux GOARCH=amd64 go build -o eraflazz-linux-amd64 ./cmd/api
```

## Future Enhancements

### 1. Distributed Tracing
- OpenTelemetry integration
- Jaeger/Zipkin support
- Cross-service trace propagation

### 2. Advanced Metrics
- Business KPI dashboards
- Custom metric builders
- Real-time alerting

### 3. Log Aggregation
- ELK stack integration
- Structured logging enhancement
- Log-based alerting

### 4. Performance Monitoring
- Application Performance Monitoring (APM)
- Profiling integration
- Memory leak detection
