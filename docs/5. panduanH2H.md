# Panduan Integrasi H2H API Key + Signature

## Overview

Dokumen ini menjelaskan cara mengintegrasikan dengan API Eraflazz menggunakan jalur H2H (Host-to-Host) dengan sistem autentikasi API Key + Signature.

## Komponen Autentikasi H2H

### 1. API Client Registration
Setiap partner yang ingin menggunakan H2H API harus memiliki API Client yang terdaftar:

```sql
-- Contoh data API Client
INSERT INTO api_clients (
    client_id, 
    api_key, 
    secret, 
    ip_whitelist, 
    is_active, 
    max_requests_per_minute
) VALUES (
    'PARTNER_001',
    'ak_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t',
    'sk_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0x1y2z3',
    ARRAY['192.168.1.100', '10.0.0.50'],
    true,
    60
);
```

### 2. Header yang Diperlukan

Setiap request H2H harus menyertakan header berikut:

```
X-Client-ID: PARTNER_001
X-API-Key: ak_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t
X-Timestamp: 1640995200
X-Signature: hmac_sha256_signature
X-Nonce: random_string_12345 (optional)
```

### 3. Format Signature

Signature dibuat menggunakan HMAC-SHA256 dengan formula:

```
signature = HMAC-SHA256(secret, timestamp + request_body)
```

#### Contoh Implementasi (Go):

```go
package main

import (
    "crypto/hmac"
    "crypto/sha256"
    "encoding/hex"
    "fmt"
    "strconv"
    "time"
)

func generateSignature(secret, timestamp string, payload []byte) string {
    dataToSign := timestamp + string(payload)
    h := hmac.New(sha256.New, []byte(secret))
    h.Write([]byte(dataToSign))
    return hex.EncodeToString(h.Sum(nil))
}

func main() {
    secret := "sk_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0x1y2z3"
    timestamp := strconv.FormatInt(time.Now().Unix(), 10)
    payload := `{"product_code": "TELKOMSEL5", "destination": "081234567890"}`
    
    signature := generateSignature(secret, timestamp, []byte(payload))
    
    fmt.Printf("Timestamp: %s\n", timestamp)
    fmt.Printf("Signature: %s\n", signature)
}
```

#### Contoh Implementasi (PHP):

```php
<?php
function generateSignature($secret, $timestamp, $payload) {
    $dataToSign = $timestamp . $payload;
    return hash_hmac('sha256', $dataToSign, $secret);
}

$secret = 'sk_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0x1y2z3';
$timestamp = time();
$payload = '{"product_code": "TELKOMSEL5", "destination": "081234567890"}';

$signature = generateSignature($secret, $timestamp, $payload);

echo "Timestamp: $timestamp\n";
echo "Signature: $signature\n";
?>
```

#### Contoh Implementasi (JavaScript/Node.js):

```javascript
const crypto = require('crypto');

function generateSignature(secret, timestamp, payload) {
    const dataToSign = timestamp + payload;
    return crypto.createHmac('sha256', secret)
                   .update(dataToSign)
                   .digest('hex');
}

const secret = 'sk_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f3g4h5i6j7k8l9m0n1o2p3q4r5s6t7u8v9w0x1y2z3';
const timestamp = Math.floor(Date.now() / 1000);
const payload = '{"product_code": "TELKOMSEL5", "destination": "081234567890"}';

const signature = generateSignature(secret, timestamp, payload);

console.log(`Timestamp: ${timestamp}`);
console.log(`Signature: ${signature}`);
```

## 4. Endpoint H2H

### Callback Endpoint
```
POST /api/v1/h2h/callback
```

#### Request Headers:
```
Content-Type: application/json
X-Client-ID: PARTNER_001
X-API-Key: ak_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t
X-Timestamp: 1640995200
X-Signature: hmac_sha256_signature
```

#### Request Body:
```json
{
    "transaction_id": "TXN123456789",
    "status": "SUCCESS",
    "product_code": "TELKOMSEL5",
    "destination": "081234567890",
    "supplier_ref": "SUP123456",
    "timestamp": "2024-01-01T12:00:00Z"
}
```

#### Response:
```json
{
    "success": true,
    "message": "H2H callback accepted",
    "data": {
        "status": "ok",
        "client_id": "PARTNER_001"
    }
}
```

## 5. Error Handling

### Common Error Responses

#### 401 Unauthorized - Missing Headers:
```json
{
    "success": false,
    "error": "Missing required H2H headers",
    "code": "MISSING_HEADERS"
}
```

#### 401 Unauthorized - Invalid Client:
```json
{
    "success": false,
    "error": "Invalid client credentials",
    "code": "INVALID_CLIENT"
}
```

#### 403 Forbidden - IP Not Allowed:
```json
{
    "success": false,
    "error": "IP address not allowed",
    "code": "IP_NOT_ALLOWED"
}
```

#### 401 Unauthorized - Invalid Signature:
```json
{
    "success": false,
    "error": "Invalid signature: timestamp expired or too far in future",
    "code": "INVALID_SIGNATURE"
}
```

## 6. Security Best Practices

### 1. Secret Management
- Simpan API Secret dengan aman
- Jangan pernah expose secret di client-side code
- Gunakan environment variables atau secret management system

### 2. Timestamp Validation
- Server menerima timestamp dengan toleransi Â±5 menit
- Pastikan clock server ter-sync dengan NTP
- Gunakan Unix timestamp dalam detik

### 3. IP Whitelist
- Daftarkan IP server yang akan mengakses API
- Gunakan static IP untuk production environment
- Monitor akses dari IP yang tidak terdaftar

### 4. Rate Limiting
- Default: 60 requests per minute per client
- Bisa disesuaikan per client
- Monitor rate limit violations

### 5. Replay Attack Prevention
- Gunakan nonce untuk request yang sensitif
- Server menyimpan last used timestamp
- Implementasi nonce validation jika diperlukan

## 7. Testing Integration

### 1. Create Test Client
```bash
curl -X POST http://localhost:8080/api/v1/admin/api-clients \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "client_id": "TEST_CLIENT",
    "ip_whitelist": ["127.0.0.1"],
    "max_requests_per_minute": 120
  }'
```

### 2. Test H2H Request
```bash
#!/bin/bash

CLIENT_ID="TEST_CLIENT"
API_KEY="GENERATED_API_KEY"
SECRET="GENERATED_SECRET"
TIMESTAMP=$(date +%s)
PAYLOAD='{"test": "data"}'

# Generate signature
SIGNATURE=$(echo -n "${TIMESTAMP}${PAYLOAD}" | openssl dgst -sha256 -hmac "$SECRET" -binary | xxd -p -c 256)

curl -X POST http://localhost:8080/api/v1/h2h/callback \
  -H "Content-Type: application/json" \
  -H "X-Client-ID: $CLIENT_ID" \
  -H "X-API-Key: $API_KEY" \
  -H "X-Timestamp: $TIMESTAMP" \
  -H "X-Signature: $SIGNATURE" \
  -d "$PAYLOAD"
```

## 8. Troubleshooting

### Common Issues

1. **Signature Mismatch**
   - Pastikan payload encoding sama (UTF-8)
   - Check timestamp format (Unix timestamp dalam detik)
   - Verify secret key yang digunakan

2. **Timestamp Expired**
   - Sync server clock dengan NTP
   - Check timezone settings
   - Gunakan timestamp yang baru untuk setiap request

3. **IP Not Allowed**
   - Verify IP address yang terdaftar
   - Check jika server menggunakan NAT/proxy
   - Gunakan IP public yang benar

4. **Rate Limit Exceeded**
   - Implementasi backoff strategy
   - Monitor request rate
   - Contact admin untuk increase limit

### Debug Tools

```bash
# Check current timestamp
date +%s

# Test signature generation
echo -n "1640995200{\"test\":\"data\"}" | openssl dgst -sha256 -hmac "your_secret" -binary | xxd -p -c 256

# Check IP address
curl ifconfig.me
```

## 9. Contact Support

Untuk bantuan integrasi H2H API:
- Email: support@eraflazz.com
- Subject: H2H API Integration - [Your Company Name]
- Include: Client ID, Error logs, Request/Response samples
